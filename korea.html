<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ì–´ë””ì¼ê¹Œìš”? - í•œêµ­ ì§€ë¦¬ í€´ì¦ˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: 'Pretendard', sans-serif;
    }

    .exit-to-index {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 2000;
      padding: 8px 16px;
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.85rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      cursor: pointer;
    }

    #ui-overlay {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 15px;
      width: 280px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      max-height: 90vh;
      overflow-y: auto;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    @media (max-width: 576px) {
      #ui-overlay {
        top: auto;
        bottom: 15px;
        right: 15px;
        left: 15px;
        width: auto;
        padding: 10px;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(5px);
      }

      .btn-game {
        padding: 8px;
        font-size: 0.9rem;
      }

      h2 {
        font-size: 1.4rem;
        margin-bottom: 5px !important;
      }

      #info-Container {
        padding: 8px;
      }
    }

    #info-Container {
      margin-top: 10px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 10px;
      display: none;
      border-left: 5px solid #28a745;
    }

    .btn-game {
      width: 100%;
      margin-top: 8px;
      padding: 10px;
      font-weight: bold;
      border-radius: 10px;
    }

    .final-result-area {
      text-align: center;
      display: none;
      padding: 10px 0;
    }

    .accuracy-val {
      font-size: 1.8rem;
      font-weight: bold;
      color: #0d6efd;
    }

    #result-accuracy-text {
      font-size: 1.7rem;
      font-weight: 900;
      color: #dc3545;
      margin-top: 5px;
      display: block;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .perfect-text {
      color: #ffc107;
      font-weight: 900;
      animation: bounce 0.5s infinite;
      font-size: 1.8rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-5px);
      }
    }

    #rank-input-area {
      background: #fff3cd;
      padding: 15px;
      border-radius: 12px;
      margin-top: 10px;
      border: 1px dashed #ffeeba;
    }
  </style>
</head>

<body>

  <button class="exit-to-index" onclick="location.href='index.html'">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>

  <div id="ui-overlay">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <span class="badge bg-dark">ë ˆë²¨ <span id="level-display">1</span></span>
      <span class="small text-muted">í‰ê·  ì •í™•ë„: <b id="avg-accuracy" class="text-primary">0</b>%</span>
    </div>

    <div id="game-play-area">
      <h2 id="cityName" class="text-primary text-center fw-bold mb-2">ë„ì‹œ ì´ë¦„</h2>
      <p id="alarm" class="small text-muted text-center mb-2">ì§€ë„ë¥¼ í„°ì¹˜í•´ ë³´ì„¸ìš”!</p>
      <button id="submitGuess" class="btn btn-primary btn-game" style="display:none;">ì •ë‹µ í™•ì¸</button>
      <button id="nextQuestion" class="btn btn-success btn-game" style="display:none;">ë‹¤ìŒ ë¬¸ì œ</button>
    </div>

    <div id="final-result-area" class="final-result-area">
      <h4 class="fw-bold mb-1" id="resultTitle">ê²°ê³¼</h4>
      <div class="accuracy-val mb-2"><span id="finalAccuracy">0</span>%</div>
      <p id="messageText" class="x-small text-muted mb-3"></p>

      <div id="rank-input-area" style="display:none;">
        <p class="small fw-bold mb-2">ğŸ† ë§ˆìŠ¤í„°ì˜ ì´ë¦„ì„ ë‚¨ê¸°ì„¸ìš”!</p>
        <input type="text" id="userName" class="form-control mb-2 text-center" placeholder="ì´ë¦„ ì…ë ¥" maxlength="10">
        <button id="saveRank" class="btn btn-warning btn-game">ëª…ì˜ˆì˜ ì „ë‹¹ ë“±ë¡</button>
      </div>

      <button id="nextLevel" class="btn btn-primary btn-game" style="display:none;">ë‹¤ìŒ ë ˆë²¨ ë„ì „</button>
      <button id="repeatLevel" class="btn btn-info btn-game text-white" style="display:none;">ì´ ë ˆë²¨ ë” í•˜ê¸°</button>
      <button id="tryAgain" class="btn btn-outline-secondary btn-game" style="display:none;">ë‹¤ì‹œ ì‹œë„í•˜ê¸°</button>
      <button class="btn btn-danger btn-game" onclick="location.href='index.html'">ê·¸ë§Œí•˜ê¸°</button>
    </div>

    <div id="info-Container">
      <div id="descriptionContainer" class="small mb-1" style="font-size: 0.85rem; line-height: 1.4;"></div>
      <div class="pt-2 border-top d-flex justify-content-between text-muted" style="font-size: 0.7rem;">
        <span>ë¼ìš´ë“œ</span>
        <span><b id="total-question">0</b> / 3</span>
      </div>
      <button id="showResultBtn" class="btn btn-warning btn-game mt-2" style="display:none;">ìµœì¢… ê²°ê³¼ í™•ì¸</button>
    </div>
  </div>

  <div id="map"></div>

  <script src="korea.js"></script>
  <script>

    let level = parseInt(localStorage.getItem('selectedLevel')) || 1;
    let cityPool = [], map, playerMarker, answerMarker, currentCity, totalAccuracy = 0, roundCount = 0;

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function initMap() {
      // ë§µ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ì„ ë•Œë§Œ ìƒˆë¡œ ìƒì„± (ë©”ëª¨ë¦¬ íš¨ìœ¨)
      if (!map) {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 36.5, lng: 127.5 }, zoom: 7, mapTypeId: "satellite", disableDefaultUI: true, gestureHandling: "greedy"
        });

        map.data.loadGeoJson('https://raw.githubusercontent.com/southkorea/southkorea-maps/master/kostat/2013/json/skorea_municipalities_geo.json');
        map.data.setStyle({ fillColor: 'transparent', strokeColor: '#ffffff', strokeWeight: 0.6, strokeOpacity: 0.4, clickable: false });

        playerMarker = new google.maps.Marker({ map: null, icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" });
        answerMarker = new google.maps.Marker({ map: null, icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" });

        map.addListener("click", (event) => {
          if (document.getElementById("info-Container").style.display === "none") {
            playerMarker.setMap(map); playerMarker.setPosition(event.latLng);
            document.getElementById("submitGuess").style.display = "block";
          }
        });

        document.getElementById("submitGuess").onclick = checkAnswer;
        document.getElementById("nextQuestion").onclick = startNewRound;
        document.getElementById("showResultBtn").onclick = showFinalResult;
        document.getElementById("repeatLevel").onclick = () => { setupLevel(); resetUI(); };
        document.getElementById("tryAgain").onclick = () => { setupLevel(); resetUI(); };
        document.getElementById("nextLevel").onclick = () => { level++; setupLevel(); resetUI(); };
        document.getElementById("saveRank").onclick = saveToHallOfFame;
      }

      setupLevel();
    }

    function setupLevel() {
      totalAccuracy = 0; roundCount = 0;
      if (level > 5) level = 5;
      document.getElementById("level-display").innerText = level;
      const targetData = levelData[level] || levelData[1];
      cityPool = shuffle([...targetData]);
      startNewRound();
    }

    function resetMapView() {
      if (map) {
        map.setCenter({ lat: 36.5, lng: 127.5 });
        map.setZoom(7);
      }
    }

    function resetUI() {
      document.getElementById("game-play-area").style.display = "block";
      document.getElementById("final-result-area").style.display = "none";
      document.getElementById("rank-input-area").style.display = "none";
    }

    function startNewRound() {
      resetMapView();
      document.getElementById("nextQuestion").style.display = "none";
      document.getElementById("info-Container").style.display = "none";
      document.getElementById("showResultBtn").style.display = "none";
      answerMarker.setMap(null); playerMarker.setMap(null);
      currentCity = cityPool.pop();
      roundCount++;
      let displayName = (level === 5) ? `${currentCity.city} ${currentCity.name}` : currentCity.name;
      document.getElementById("cityName").innerText = displayName;
      document.getElementById("alarm").innerText = "ì§€ë„ë¥¼ í„°ì¹˜í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì¡ìœ¼ì„¸ìš”!";
      updateScoreboard();
    }

    function checkAnswer() {
      document.getElementById("submitGuess").style.display = "none";
      document.getElementById("info-Container").style.display = "block";
      const cityPos = new google.maps.LatLng(currentCity.lat, currentCity.lng);
      const distance = google.maps.geometry.spherical.computeDistanceBetween(playerMarker.getPosition(), cityPos);

      let accuracy, threshold, penalty;
      if (level === 5) { threshold = 5000; penalty = 800; }
      else if (level >= 3) { threshold = 15000; penalty = 1500; }
      else { threshold = 20000; penalty = 2000; }

      accuracy = (distance <= threshold) ? 100 : Math.max(0, 100 - (distance - threshold) / penalty);
      totalAccuracy += accuracy;

      let feedback = accuracy >= 99 ? "<span class='perfect-text'>PERFECT!</span>" : `<span id='result-accuracy-text'>ì •í™•ë„: ${accuracy.toFixed(1)}%</span>`;
      document.getElementById("alarm").innerHTML = `${feedback}<br><small class='text-muted'>ì˜¤ì°¨: ${(distance / 1000).toFixed(1)}km</small>`;

      answerMarker.setPosition(cityPos); answerMarker.setMap(map);
      document.getElementById("descriptionContainer").innerText = currentCity.desc;

      // ì •ë‹µ ìœ„ì¹˜(ì´ˆë¡ ë§ˆì»¤)ë¥¼ ìƒë‹¨ 40%ì— ë°°ì¹˜í•˜ê³ , 
      // ì‚¬ìš©ì ì„ íƒ(íŒŒë€ ë§ˆì»¤)ì´ í™”ë©´ ì•ˆì— ê³ ë£¨ ë“¤ì–´ì˜¤ë„ë¡ ì§€ëŠ¥ì  ì¤Œ ì¡°ì ˆ
      const posG = currentCity;
      const posB = playerMarker.getPosition();
      const latDiff = Math.abs(posG.lat - posB.lat());
      const lngDiff = Math.abs(posG.lng - posB.lng());
      const height = document.getElementById("map").offsetHeight;
      const width = document.getElementById("map").offsetWidth;

      // ìœ„ë„/ê²½ë„ 1ë„ë‹¹ í”½ì…€ ìˆ˜ (í•œêµ­ ì§€ì—­ Heuristic)
      const getPixelsPerLat = (z) => 0.88 * Math.pow(2, z);
      const getPixelsPerLng = (z) => 0.70 * Math.pow(2, z);

      let targetZoom = 12;
      for (let z = 12; z >= 5; z--) {
        const pxLat = getPixelsPerLat(z);
        const pxLng = getPixelsPerLng(z);
        const isLngOk = (lngDiff * pxLng) <= (width * 0.4);
        let isLatOk = false;
        if (posB.lat() < posG.lat) { // íŒŒë€ ë§ˆì»¤ê°€ ë‚¨ìª½
          isLatOk = (latDiff * pxLat) <= (height * 0.2);
        } else { // íŒŒë€ ë§ˆì»¤ê°€ ë¶ìª½
          isLatOk = (latDiff * pxLat) <= (height * 0.4);
        }
        if (isLngOk && isLatOk) {
          targetZoom = z;
          break;
        }
      }

      map.setZoom(targetZoom);
      map.panTo(cityPos);

      // ì •ë‹µ ë§ˆì»¤ ê°•ì¡°: ë¼ë²¨ ì¶”ê°€ ë° ì• ë‹ˆë©”ì´ì…˜
      answerMarker.setLabel({ text: "ì •ë‹µ", color: "white", fontWeight: "bold", fontSize: "14px" });
      answerMarker.setAnimation(google.maps.Animation.BOUNCE);
      setTimeout(() => answerMarker.setAnimation(null), 3000); // 3ì´ˆ í›„ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ë‹¨

      google.maps.event.addListenerOnce(map, 'idle', () => {
        map.panBy(0, height * 0.1);
      });

      // ìŒì„± ì•ˆë‚´ ê¸°ëŠ¥ ì¶”ê°€ (TTS)
      speak(currentCity.desc);

      if (roundCount < 3) document.getElementById("nextQuestion").style.display = "block";
      else document.getElementById("showResultBtn").style.display = "block";
      updateScoreboard();
    }

    function updateScoreboard() {
      const avg = roundCount === 0 ? 0 : (totalAccuracy / roundCount);
      document.getElementById("avg-accuracy").innerText = avg.toFixed(1);
    }

    function fireConfetti() {
      var duration = 5 * 1000;
      var animationEnd = Date.now() + duration;
      var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
      var interval = setInterval(function () {
        var timeLeft = animationEnd - Date.now();
        if (timeLeft <= 0) return clearInterval(interval);
        var particleCount = 50 * (timeLeft / duration);
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: Math.random() * 0.2 + 0.1, y: Math.random() - 0.2 } }));
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: Math.random() * 0.2 + 0.7, y: Math.random() - 0.2 } }));
      }, 250);
    }

    function showFinalResult() {
      document.getElementById("game-play-area").style.display = "none";
      document.getElementById("info-Container").style.display = "none";
      document.getElementById("final-result-area").style.display = "block";
      const finalAvg = (totalAccuracy / 3).toFixed(1);
      document.getElementById("finalAccuracy").innerText = finalAvg;
      const successCut = (level === 5) ? 85 : 75;
      const isSuccess = finalAvg >= successCut;

      if (level === 5 && isSuccess) {
        document.getElementById("resultTitle").innerText = "ğŸ† ì§€ë¦¬ ë§ˆìŠ¤í„° ë“±ê·¹! ğŸ†";
        document.getElementById("messageText").innerText = "ëŒ€ë‹¨í•©ë‹ˆë‹¤! ëª…ì˜ˆì˜ ì „ë‹¹ì— ì´ë¦„ì„ ë‚¨ê¸°ì„¸ìš”.";
        document.getElementById("rank-input-area").style.display = "block";
        fireConfetti();
      } else if (isSuccess) {
        document.getElementById("resultTitle").innerText = "ë ˆë²¨ í†µê³¼! ğŸ‰";
        document.getElementById("messageText").innerText = "ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
        document.getElementById("nextLevel").style.display = (level < 5) ? "block" : "none";
      } else {
        document.getElementById("resultTitle").innerText = "ì•„ì‰¬ì›Œìš”! ğŸ˜…";
        document.getElementById("messageText").innerText = `í‰ê·  ${successCut}% ì´ìƒì´ í•„ìš”í•©ë‹ˆë‹¤.`;
        document.getElementById("tryAgain").style.display = "block";
      }
      document.getElementById("repeatLevel").style.display = isSuccess ? "block" : "none";
    }

    function saveToHallOfFame() {
      const name = document.getElementById("userName").value || "ë¬´ëª… ë§ˆìŠ¤í„°";
      const score = (totalAccuracy / 3).toFixed(1);
      const entry = { name, score, date: new Date().toLocaleDateString() };
      let fameData = JSON.parse(localStorage.getItem('hallOfFame')) || [];
      fameData.unshift(entry);
      localStorage.setItem('hallOfFame', JSON.stringify(fameData.slice(0, 5)));
      location.href = 'index.html';
    }

    // ê³ í’ˆì§ˆ ìŒì„± ì•ˆë‚´ (TTS)
    function speak(text) {
      if ('speechSynthesis' in window) {
        // ì´ì „ ìŒì„± ì¤‘ë‹¨
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;

        // ê³ í’ˆì§ˆ í•œêµ­ì–´ ìŒì„± ì°¾ê¸° ì‹œë„
        const voices = window.speechSynthesis.getVoices();
        const koVoice = voices.find(v => v.lang.includes('ko') && (v.name.includes('Google') || v.name.includes('Premium')));
        if (koVoice) utterance.voice = koVoice;

        window.speechSynthesis.speak(utterance);
      }
    }
    // ìŒì„± ëª©ë¡ ë¯¸ë¦¬ ë¡œë“œ (ì¼ë¶€ ë¸Œë¼ìš°ì € ëŒ€ì‘)
    window.speechSynthesis.getVoices();
  </script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBEGmiiFjkqhyKBRuFfdz3WqpPzLleeDMA&libraries=geometry&callback=initMap"
    async defer></script>
</body>

</html>
