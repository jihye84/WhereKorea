<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë„ì‹œ ìœ„ì¹˜ ì°¾ê¸° - í•œêµ­</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: 'Pretendard', sans-serif;
    }

    .exit-to-index {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 2000;
      padding: 8px 16px;
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.85rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      cursor: pointer;
    }

    #ui-overlay {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 15px;
      width: 280px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      max-height: 90vh;
      overflow-y: auto;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    @media (max-width: 576px) {
      #ui-overlay {
        top: auto;
        bottom: 20px;
        right: 10px;
        left: 10px;
        width: calc(100% - 20px);
      }
    }

    #info-Container {
      margin-top: 10px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 10px;
      display: none;
      border-left: 5px solid #28a745;
    }

    .btn-game {
      width: 100%;
      margin-top: 8px;
      padding: 10px;
      font-weight: bold;
      border-radius: 10px;
    }

    .final-result-area {
      text-align: center;
      display: none;
      padding: 10px 0;
    }

    .accuracy-val {
      font-size: 1.8rem;
      font-weight: bold;
      color: #0d6efd;
    }

    .perfect-text {
      color: #ffc107;
      font-weight: bold;
      animation: bounce 0.5s infinite;
    }

    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-5px);
      }
    }
  </style>
</head>

<body>

  <button class="exit-to-index" onclick="location.href='index.html'">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>

  <div id="ui-overlay">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <span class="badge bg-dark">ë ˆë²¨ <span id="level-display">1</span></span>
      <span class="small text-muted">í‰ê·  ì •í™•ë„: <b id="avg-accuracy" class="text-primary">0</b>%</span>
    </div>

    <div id="game-play-area">
      <h2 id="cityName" class="text-primary text-center fw-bold mb-2">ë„ì‹œ ì´ë¦„</h2>
      <p id="alarm" class="small text-muted text-center mb-2">ì§€ë„ë¥¼ í„°ì¹˜í•´ ë³´ì„¸ìš”!</p>
      <button id="submitGuess" class="btn btn-primary btn-game" style="display:none;">ì •ë‹µ í™•ì¸</button>
      <button id="nextQuestion" class="btn btn-success btn-game" style="display:none;">ë‹¤ìŒ ë¬¸ì œ</button>
    </div>

    <div id="final-result-area" class="final-result-area">
      <h4 class="fw-bold mb-1" id="resultTitle">ê²°ê³¼</h4>
      <div class="accuracy-val mb-2"><span id="finalAccuracy">0</span>%</div>
      <p id="messageText" class="x-small text-muted mb-3"></p>
      <button id="nextLevel" class="btn btn-primary btn-game" style="display:none;">ë‹¤ìŒ ë ˆë²¨ ë„ì „</button>
      <button id="repeatLevel" class="btn btn-info btn-game text-white" style="display:none;">ì´ ë ˆë²¨ ë” í•˜ê¸°</button>
      <button id="tryAgain" class="btn btn-outline-secondary btn-game" style="display:none;">ë‹¤ì‹œ ì‹œë„í•˜ê¸°</button>
      <button class="btn btn-danger btn-game" onclick="location.href='index.html'">ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <div id="info-Container">
      <div id="descriptionContainer" class="small mb-1" style="font-size: 0.85rem; line-height: 1.4;"></div>
      <div class="pt-2 border-top d-flex justify-content-between text-muted" style="font-size: 0.7rem;">
        <span>ë¼ìš´ë“œ</span>
        <span><b id="total-question">0</b> / 3</span>
      </div>
      <button id="showResultBtn" class="btn btn-warning btn-game mt-2" style="display:none;">ìµœì¢… ê²°ê³¼ í™•ì¸</button>
    </div>
  </div>

  <div id="map"></div>

  <script>
    const levelData = {
      1: [
        { name: "ì„œìš¸íŠ¹ë³„ì‹œ", lat: 37.5665, lng: 126.9780, desc: "ëŒ€í•œë¯¼êµ­ì˜ ìˆ˜ë„" },
        { name: "ë¶€ì‚°ê´‘ì—­ì‹œ", lat: 35.1796, lng: 129.0756, desc: "ì œ1ì˜ í•­êµ¬ë„ì‹œ" },
        { name: "ëŒ€êµ¬ê´‘ì—­ì‹œ", lat: 35.8714, lng: 128.6014, desc: "ë‚´ë¥™ ë¶„ì§€ ë„ì‹œ" },
        { name: "ì¸ì²œê´‘ì—­ì‹œ", lat: 37.4563, lng: 126.6052, desc: "êµ­ì œê³µí•­ì´ ìˆëŠ” ê´€ë¬¸" },
        { name: "ê´‘ì£¼ê´‘ì—­ì‹œ", lat: 35.1595, lng: 126.9121, desc: "í˜¸ë‚¨ì˜ ì¤‘ì‹¬ì§€" },
        { name: "ëŒ€ì „ê´‘ì—­ì‹œ", lat: 36.3504, lng: 127.3845, desc: "ê³¼í•™ê¸°ìˆ ì˜ ë„ì‹œ" },
        { name: "ìš¸ì‚°ê´‘ì—­ì‹œ", lat: 35.5384, lng: 129.3114, desc: "ì‚°ì—…ì˜ ìˆ˜ë„" },
        { name: "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", lat: 36.4800, lng: 127.2890, desc: "í–‰ì •ì¤‘ì‹¬ë³µí•©ë„ì‹œ" }
      ],
      2: [
        { name: "ìˆ˜ì›ì‹œ", lat: 37.2636, lng: 127.0286, desc: "ê²½ê¸°ë„ì²­ ì†Œì¬ì§€" },
        { name: "ì¶˜ì²œì‹œ", lat: 37.8813, lng: 127.7298, desc: "ê°•ì›íŠ¹ë³„ìì¹˜ë„ì²­ ì†Œì¬ì§€" },
        { name: "ì²­ì£¼ì‹œ", lat: 36.6424, lng: 127.4890, desc: "ì¶©ë¶ë„ì²­ ì†Œì¬ì§€" },
        { name: "í™ì„±êµ°", lat: 36.6013, lng: 126.6608, desc: "ì¶©ë‚¨ë„ì²­ ì†Œì¬ì§€ (ë‚´í¬ì‹ ë„ì‹œ)" },
        { name: "ì „ì£¼ì‹œ", lat: 35.8242, lng: 127.1480, desc: "ì „ë¶ë„ì²­ ì†Œì¬ì§€" },
        { name: "ë¬´ì•ˆêµ°", lat: 34.9904, lng: 126.4817, desc: "ì „ë‚¨ë„ì²­ ì†Œì¬ì§€" },
        { name: "ì•ˆë™ì‹œ", lat: 36.5684, lng: 128.7294, desc: "ê²½ë¶ë„ì²­ ì†Œì¬ì§€" },
        { name: "ì°½ì›ì‹œ", lat: 35.2279, lng: 128.6811, desc: "ê²½ë‚¨ë„ì²­ ì†Œì¬ì§€" },
        { name: "ì œì£¼ì‹œ", lat: 33.4996, lng: 126.5312, desc: "ì œì£¼íŠ¹ë³„ìì¹˜ë„ì²­ ì†Œì¬ì§€" }
      ],
      3: [
        { name: "ì²œì•ˆì‹œ", lat: 36.8151, lng: 127.1139, desc: "ì¶©ë‚¨ ìµœëŒ€ ë„ì‹œ" },
        { name: "í¬í•­ì‹œ", lat: 36.0190, lng: 129.3520, desc: "ì² ê°• ì‚°ì—…ì˜ ì¤‘ì‹¬" },
        { name: "ì›ì£¼ì‹œ", lat: 37.3422, lng: 127.9202, desc: "ê°•ì›ê¶Œ ìµœëŒ€ ë„ì‹œ" },
        { name: "êµ¬ë¯¸ì‹œ", lat: 36.1195, lng: 128.3443, desc: "ì „ì ì‚°ì—…ì˜ ë©”ì¹´" },
        { name: "ëª©í¬ì‹œ", lat: 34.8118, lng: 126.3922, desc: "í•­êµ¬ì™€ ê·¼ëŒ€ ì—­ì‚¬ì˜ ë„ì‹œ" },
        { name: "ì§„ì£¼ì‹œ", lat: 35.1803, lng: 128.1076, desc: "ì„œë¶€ ê²½ë‚¨ì˜ êµìœ¡ ë„ì‹œ" },
        { name: "ë³´ë ¹ì‹œ", lat: 36.3332, lng: 126.6128, desc: "ë¨¸ë“œ ì¶•ì œì˜ ê³ ì¥" },
        { name: "ê²½ì£¼ì‹œ", lat: 35.8562, lng: 129.2247, desc: "ì²œë…„ê³ ë„ ì‹ ë¼ ìˆ˜ë„" }
      ],
      4: [
        { name: "í‰ì°½êµ°", lat: 37.3705, lng: 128.3905, desc: "ë™ê³„ ì˜¬ë¦¼í”½ì˜ ê³ ì¥" },
        { name: "ìš¸ë¦‰êµ°", lat: 37.4843, lng: 130.9056, desc: "ë™í•´ì˜ ë³´ì„ ìš¸ë¦‰ë„" },
        { name: "ì™„ë„êµ°", lat: 34.3114, lng: 126.7551, desc: "ì „ë³µê³¼ ì²­ì • ë°”ë‹¤ì˜ ê³ ì¥" },
        { name: "ê°•í™”êµ°", lat: 37.7461, lng: 126.4878, desc: "ì§€ë¶• ì—†ëŠ” ë°•ë¬¼ê´€" },
        { name: "íƒœì•ˆêµ°", lat: 36.7455, lng: 126.2974, desc: "ì•„ë¦„ë‹¤ìš´ ì„œí•´ í•´ì•ˆì„ " },
        { name: "ì˜ì›”êµ°", lat: 37.1833, lng: 128.4611, desc: "ë™ê°• ì ˆê²½ê³¼ ì‚°ì´Œì˜ ê³ ì¥" },
        { name: "ë¶€ì—¬êµ°", lat: 36.2750, lng: 126.9094, desc: "ë°±ì œ ë¬¸í™”ìœ ì‚°ì˜ ì¤‘ì‹¬" },
        { name: "í•¨í‰êµ°", lat: 35.0660, lng: 126.5164, desc: "ë‚˜ë¹„ ì¶•ì œê°€ ì—´ë¦¬ëŠ” ê³³" }
      ],
      5: [
        { name: "ì‚¬í•˜êµ¬", lat: 35.1044, lng: 128.9680, desc: "ë¶€ì‚°ì˜ ì„œë‚¨ìª½ êµ¬" },
        { name: "ì˜ë„êµ¬", lat: 35.0912, lng: 129.0677, desc: "ë¶€ì‚°í•­ ì•ë°”ë‹¤ì˜ ì„¬ êµ¬" },
        { name: "ë„ë´‰êµ¬", lat: 37.6688, lng: 127.0471, desc: "ì„œìš¸ì˜ ë¶ìª½ ë êµ¬" },
        { name: "ë‹¬ì„œêµ¬", lat: 35.8299, lng: 128.5327, desc: "ëŒ€êµ¬ ìµœëŒ€ ì¸êµ¬ ê±°ì£¼êµ¬" },
        { name: "ê´‘ì‚°êµ¬", lat: 35.1396, lng: 126.7915, desc: "ê´‘ì£¼ì˜ ê´€ë¬¸ì´ì ì‚°ë‹¨ êµ¬" },
        { name: "ìˆ˜ì˜êµ¬", lat: 35.1456, lng: 129.1132, desc: "ê´‘ì•ˆë¦¬ í•´ë³€ì´ ìˆëŠ” êµ¬" },
        { name: "ë…¸ì›êµ¬", lat: 37.6542, lng: 127.0568, desc: "ì„œìš¸ì˜ ì£¼ê±° êµìœ¡ ì¤‘ì‹¬" },
        { name: "ë¶€í‰êµ¬", lat: 37.5070, lng: 126.7219, desc: "ì¸ì²œì˜ ì¸êµ¬ ë°€ì§‘ êµ¬" }
      ]
    };

    // ğŸ’¡ ë©”ì¸ì—ì„œ ì„ íƒí•œ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ 1ë¡œ ì‹œì‘)
    let level = parseInt(localStorage.getItem('selectedLevel')) || 1;
    let cityPool = [], map, playerMarker, answerMarker, currentCity, totalAccuracy = 0, roundCount = 0;

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function initMap() {
      totalAccuracy = 0;
      roundCount = 0;

      // í˜„ì¬ ë ˆë²¨ í‘œì‹œ ì—…ë°ì´íŠ¸
      document.getElementById("level-display").innerText = level;

      const targetData = levelData[level] || levelData[1];
      cityPool = shuffle([...targetData]);

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 36.5, lng: 127.5 }, zoom: 7, mapTypeId: "satellite", disableDefaultUI: true, gestureHandling: "greedy"
      });

      map.data.loadGeoJson('https://raw.githubusercontent.com/southkorea/southkorea-maps/master/kostat/2013/json/skorea_municipalities_geo.json');
      map.data.setStyle({ fillColor: 'transparent', strokeColor: '#ffffff', strokeWeight: 0.6, strokeOpacity: 0.4, clickable: false });

      playerMarker = new google.maps.Marker({ map: null, icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" });
      answerMarker = new google.maps.Marker({ map: null, icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" });

      map.addListener("click", (event) => {
        if (document.getElementById("info-Container").style.display === "none") {
          playerMarker.setMap(map); playerMarker.setPosition(event.latLng);
          document.getElementById("submitGuess").style.display = "block";
        }
      });

      document.getElementById("submitGuess").onclick = checkAnswer;
      document.getElementById("nextQuestion").onclick = startNewRound;
      document.getElementById("showResultBtn").onclick = showFinalResult;
      document.getElementById("repeatLevel").onclick = () => { initMap(); resetUI(); };
      document.getElementById("tryAgain").onclick = () => { initMap(); resetUI(); };
      document.getElementById("nextLevel").onclick = () => { level++; initMap(); resetUI(); };

      startNewRound();
    }

    function resetUI() {
      document.getElementById("game-play-area").style.display = "block";
      document.getElementById("final-result-area").style.display = "none";
      document.getElementById("nextLevel").style.display = "none";
      document.getElementById("repeatLevel").style.display = "none";
      document.getElementById("tryAgain").style.display = "none";
    }

    function startNewRound() {
      document.getElementById("nextQuestion").style.display = "none";
      document.getElementById("info-Container").style.display = "none";
      document.getElementById("showResultBtn").style.display = "none";
      answerMarker.setMap(null); playerMarker.setMap(null);

      currentCity = cityPool.pop();
      roundCount++;
      document.getElementById("cityName").innerText = currentCity.name;
      document.getElementById("alarm").innerText = "ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ í„°ì¹˜í•˜ì„¸ìš”!";
      updateScoreboard();
    }

    function checkAnswer() {
      document.getElementById("submitGuess").style.display = "none";
      document.getElementById("info-Container").style.display = "block";
      const cityPos = new google.maps.LatLng(currentCity.lat, currentCity.lng);
      const playerPos = playerMarker.getPosition();

      // ğŸ’¡ geometry ë¼ì´ë¸ŒëŸ¬ë¦¬ í™œìš© ê±°ë¦¬ ê³„ì‚°
      const distance = google.maps.geometry.spherical.computeDistanceBetween(playerPos, cityPos);

      let accuracy;
      let threshold = (level <= 2) ? 15000 : 12000; // ì§€í˜œë‹˜ ë§ì¶¤í˜• ê´€ëŒ€í•œ ê¸°ì¤€

      if (distance <= threshold) {
        accuracy = 100;
      } else {
        accuracy = Math.max(0, 100 - (distance - threshold) / 1500);
      }

      totalAccuracy += accuracy;
      let feedback = accuracy >= 98 ? "<span class='perfect-text'>PERFECT! ì •í™•í•´ìš”!</span>" : `ì˜¤ì°¨: <b>${(distance / 1000).toFixed(1)}km</b>`;
      document.getElementById("alarm").innerHTML = `${feedback}<br>ì •í™•ë„: <b>${accuracy.toFixed(1)}%</b>`;

      answerMarker.setPosition(cityPos); answerMarker.setMap(map);
      document.getElementById("descriptionContainer").innerText = currentCity.desc;
      updateScoreboard();

      if (roundCount < 3) document.getElementById("nextQuestion").style.display = "block";
      else document.getElementById("showResultBtn").style.display = "block";
    }

    function updateScoreboard() {
      const avg = roundCount === 0 ? 0 : (totalAccuracy / roundCount);
      document.getElementById("avg-accuracy").innerText = avg.toFixed(1);
      document.getElementById("level-display").innerText = level;
      document.getElementById("total-question").innerText = roundCount;
    }

    function showFinalResult() {
      document.getElementById("game-play-area").style.display = "none";
      document.getElementById("info-Container").style.display = "none";
      document.getElementById("final-result-area").style.display = "block";

      const finalAvg = (totalAccuracy / 3).toFixed(1);
      document.getElementById("finalAccuracy").innerText = finalAvg;
      const isSuccess = finalAvg >= 75;

      if (level < 5) {
        document.getElementById("resultTitle").innerText = isSuccess ? "ë ˆë²¨ í†µê³¼! ğŸ‰" : "ì•„ì‰¬ì›Œìš”! ğŸ˜…";
        document.getElementById("messageText").innerText = isSuccess ? "ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°ˆ ì¤€ë¹„ê°€ ë˜ì…¨ë‚˜ìš”?" : "í‰ê·  75% ì´ìƒì„ ë‹¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤.";
        document.getElementById("nextLevel").style.display = isSuccess ? "block" : "none";
        document.getElementById("repeatLevel").style.display = isSuccess ? "block" : "none";
        document.getElementById("tryAgain").style.display = isSuccess ? "none" : "block";
      } else {
        document.getElementById("resultTitle").innerText = isSuccess ? "ë§ˆìŠ¤í„° ë‹¬ì„±! ğŸ†" : "ë§ˆì§€ë§‰ ê³ ë¹„! ğŸ˜…";
        document.getElementById("messageText").innerText = isSuccess ? "ì¶•í•˜í•©ë‹ˆë‹¤! í•œêµ­ ì§€ë¦¬ ë§ˆìŠ¤í„°ê°€ ë˜ì…¨ìŠµë‹ˆë‹¤." : "80%ë¥¼ ë„˜ê²¨ì„œ ìµœì¢… ë§ˆìŠ¤í„°ì— ë„ì „í•´ ë³´ì„¸ìš”!";
        document.getElementById("repeatLevel").style.display = "block";
        document.getElementById("tryAgain").style.display = isSuccess ? "none" : "block";
      }
    }
  </script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBEGmiiFjkqhyKBRuFfdz3WqpPzLleeDMA&libraries=geometry&callback=initMap"
    async defer></script>
</body>

</html>